#!/bin/bash

# Variables
USER_HOME="$HOME"
USER_NAME=$(whoami)
SCRIPT_PATH="$USER_HOME/changer_mdp.sh"
DESKTOP_FILE="$USER_HOME/Bureau/ChangerMotDePasse.desktop"
SUDOERS_FILE="/etc/sudoers.d/chpasswd-$USER_NAME"

# 1. Création du script de changement de mot de passe
cat > "$SCRIPT_PATH" << 'EOF'
#!/bin/bash

CURRENT_USER=$(whoami)

NEW_PASS=$(zenity --password --title="Définir votre nouveau mot de passe")
[ -z "$NEW_PASS" ] && exit 1

CONFIRM_PASS=$(zenity --password --title="Confirmer votre mot de passe")
[ -z "$CONFIRM_PASS" ] && exit 1

if [ "$NEW_PASS" != "$CONFIRM_PASS" ]; then
    zenity --error --text="Les mots de passe ne correspondent pas."
    exit 1
fi

echo "$CURRENT_USER:$NEW_PASS" | sudo /usr/sbin/chpasswd

zenity --info --text="Mot de passe modifié avec succès."
EOF

chmod +x "$SCRIPT_PATH"
echo "[OK] Script de changement de mot de passe créé : $SCRIPT_PATH"

# 2. Création de l'icône sur le bureau
mkdir -p "$USER_HOME/Bureau"
cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Name=Changer mon mot de passe
Comment=Définir un nouveau mot de passe utilisateur
Exec=sh -c 'bash $SCRIPT_PATH'
Icon=dialog-password
Terminal=false
Type=Application
Categories=Utility;
EOF

chmod +x "$DESKTOP_FILE"
echo "[OK] Icône créée sur le bureau : $DESKTOP_FILE"

# 3. Ajout de la règle sudoers pour autoriser chpasswd sans mot de passe
if [ ! -f "$SUDOERS_FILE" ]; then
    echo "$USER_NAME ALL=(ALL) NOPASSWD: /usr/sbin/chpasswd" | sudo tee "$SUDOERS_FILE" > /dev/null
    sudo chmod 440 "$SUDOERS_FILE"
    echo "[OK] Règle sudoers ajoutée pour $USER_NAME"
else
    echo "[INFO] La règle sudoers existe déjà : $SUDOERS_FILE"
fi

echo
echo "✅ Tout est prêt ! Tu peux maintenant cliquer sur l'icône 'Changer mon mot de passe' sur ton bureau."