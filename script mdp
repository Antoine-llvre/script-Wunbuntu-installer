#!/usr/bin/env python3

import gi
import subprocess
import getpass

gi.require_version("Gtk", "3.0")
from gi.repository import Gtk

class PasswordChangeWindow(Gtk.Window):
    def __init__(self):
        super().__init__(title="Changer le mot de passe")
        self.set_border_width(20)
        self.set_default_size(400, 200)

        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=15)
        self.add(vbox)

        label = Gtk.Label(label="Veuillez entrer et confirmer votre nouveau mot de passe :")
        label.set_line_wrap(True)
        vbox.pack_start(label, False, False, 0)

        grid = Gtk.Grid(column_spacing=10, row_spacing=10)
        vbox.pack_start(grid, True, True, 0)

        self.entry_new = Gtk.Entry()
        self.entry_new.set_visibility(False)
        grid.attach(Gtk.Label(label="Nouveau mot de passe :"), 0, 0, 1, 1)
        grid.attach(self.entry_new, 1, 0, 1, 1)

        self.entry_confirm = Gtk.Entry()
        self.entry_confirm.set_visibility(False)
        grid.attach(Gtk.Label(label="Confirmer le mot de passe :"), 0, 1, 1, 1)
        grid.attach(self.entry_confirm, 1, 1, 1, 1)

        button = Gtk.Button(label="Valider")
        button.connect("clicked", self.on_validate)
        vbox.pack_start(button, False, False, 0)

    def on_validate(self, widget):
        new_pass = self.entry_new.get_text()
        confirm_pass = self.entry_confirm.get_text()

        if new_pass != confirm_pass:
            self.show_message("Les mots de passe ne correspondent pas.", Gtk.MessageType.ERROR)
            return

        username = getpass.getuser()

        try:
            subprocess.run(
                ["sudo", "/usr/sbin/chpasswd"],
                input=f"{username}:{new_pass}".encode(),
                check=True
            )
            self.show_message("Mot de passe modifié avec succès.", Gtk.MessageType.INFO)
            Gtk.main_quit()
        except subprocess.CalledProcessError:
            self.show_message("Erreur : impossible de modifier le mot de passe.", Gtk.MessageType.ERROR)

    def show_message(self, message, type):
        dialog = Gtk.MessageDialog(
            parent=self,
            flags=0,
            message_type=type,
            buttons=Gtk.ButtonsType.OK,
            text=message,
        )
        dialog.run()
        dialog.destroy()

win = PasswordChangeWindow()
win.connect("destroy", Gtk.main_quit)
win.show_all()
Gtk.main()
